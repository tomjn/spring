name: Build Engine

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ 'ubuntu' ]
        arch: [ '64' ]
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Checkout submodules
        uses: textbook/git-checkout-submodule-action@master
      - name: Apt Update
        run: sudo apt-get update
      # - name: Add Mingw-64 Apt Repo
      #   run: sudo add-apt-repository ppa:tobydox/mingw-x-trusty
      # - name: Install Mingw dependencies
      #   run: >
      #     sudo apt-get install mingw-x-binutils mingw-x-gcc
      #     mingw-x-runtime mingw-x-w32api
      - name: Install build dependencies
        run: >
          sudo apt-get install --fix-missing libglew-dev libsdl2-dev libdevil-dev 
          libogg-dev libvorbis-dev libfreetype6-dev p7zip-full libxcursor-dev 
          libboost-thread-dev libboost-regex-dev libboost-system-dev 
          libboost-program-options-dev libboost-signals-dev libopenal-dev 
          libboost-chrono-dev libboost-filesystem-dev libunwind8-dev 
          default-jdk libcurl4-gnutls-dev
      - name: Get Date
        id: get-date
        run: |
          echo "::set-output name=date::$(/bin/date -u "+%Y%v")"
        shell: bash
      - uses: actions/cache@v2
        id: cache
        with:
          path: '~/builds/${{ runner.os }}-${{ runner.arch }}'
          key: ${{ runner.os }}-${{ runner.arch }}-${{ steps.get-date.outputs.date }}-${{ github.ref }}
      - name: Run CMake
        uses: lukka/run-cmake@v2
        id: runcmake
        with:
          buildDirectory: '~/builds/${{ runner.os }}-${{ runner.arch }}'
          cmakeGenerator: 'UnixMakefiles'
          cmakeListsOrSettingsJson: 'CMakeListsTxtAdvanced'
          cmakeListsTxtPath: '${{ github.workspace }}/CMakeLists.txt'
          useShell: bash
          buildWithCMake: false
      - name: Make Engine
        run: "make spring"
        working-directory: '~/builds/${{ runner.os }}-${{ runner.arch }}'
      - name: Setup Artefact Folder
        run : |
          mkdir -p /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          cd ~/builds/${{ runner.os }}-${{ runner.arch }}/
          cp libunitsync.so /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          cp springsettings.cfg /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          cp spring /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          cp -rf base /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          cp -rf AI /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          cd /tmp/engine/${{ runner.os }}-${{ runner.arch }}
          find . -name "CMakeFiles" -type d -exec rm -rf {} \;
          find . -name "cmake_install.cmake" -exec rm -rf {} \;
          find . -name "Makefile" -exec rm -rf {} \;
      - uses: actions/upload-artifact@v2
        with:
          name: ${{runner.os}}
          path: '/tmp/engine/${{ runner.os }}-${{ runner.arch }}' # or path/to/artifact ${{ github.workspace }}/../..
