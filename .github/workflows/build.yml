name: Build Engine

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ 'ubuntu' ]
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Checkout submodules
        uses: textbook/git-checkout-submodule-action@master
      - name: Apt Update
        run: sudo apt-get update
      # - name: Add Mingw-64 Apt Repo
      #   run: sudo add-apt-repository ppa:tobydox/mingw-x-trusty
      # - name: Install Mingw dependencies
      #   run: >
      #     sudo apt-get install mingw-x-binutils mingw-x-gcc
      #     mingw-x-runtime mingw-x-w32api
      - name: Install build dependencies
        run: >
          sudo apt-get install --fix-missing libglew-dev libsdl2-dev libdevil-dev 
          libogg-dev libvorbis-dev libfreetype6-dev p7zip-full libxcursor-dev 
          libboost-thread-dev libboost-regex-dev libboost-system-dev 
          libboost-program-options-dev libboost-signals-dev libopenal-dev 
          libboost-chrono-dev libboost-filesystem-dev libunwind8-dev 
          default-jdk libcurl4-gnutls-dev
      - name: Setup cross-compile folders
        run: mkdir -p /tmp/spring/${{ runner.os }}
      - uses: actions/cache@v2
        id: cache
        with:
          path: '${{ github.workspace }}/ghbuild'
          key: ${{ runner.os }}-${{ github.ref }}
      - name: Run CMake
        uses: lukka/run-cmake@v2
        id: runcmake
        with:
          buildDirectory: '${{ github.workspace }}/ghbuild'
          cmakeGenerator: 'UnixMakefiles'
          cmakeListsOrSettingsJson: 'CMakeListsTxtAdvanced'
          cmakeListsTxtPath: '${{ github.workspace }}/CMakeLists.txt'
          useShell: bash
          buildWithCMake: false
          cmakeAppendedArgs: "-DCMAKE_INSTALL_PREFIX=/tmp/spring/${{ runner.os }}"
      - name: Make Engine
        run: "make spring"
        working-directory: '${{ github.workspace }}/ghbuild'
      - name: Install built spring to /tmp/spring/${{ runner.os }}
        run: "make install"
        working-directory: '${{ github.workspace }}/ghbuild'
      - uses: actions/upload-artifact@v2
        with:
          name: build folder
          path: '/tmp/spring/${{ runner.os }}' # or path/to/artifact ${{ github.workspace }}/../..
